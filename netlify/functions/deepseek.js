// Netlifyå‡½æ•° - å®Œæ•´ç‰ˆï¼ˆåŒ…å«DeepSeek AIï¼‰
exports.handler = async (event, context) => {
  console.log('=== Netlifyå‡½æ•°è¢«è°ƒç”¨ ===', event.httpMethod);
  
  // è®¾ç½®CORSå¤´
  const headers = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type'
  };
  
  // å¤„ç†OPTIONSé¢„æ£€è¯·æ±‚
  if (event.httpMethod === 'OPTIONS') {
    return { statusCode: 200, headers, body: '' };
  }
  
  // å¤„ç†GETè¯·æ±‚
  if (event.httpMethod === 'GET') {
    const response = {
      status: 'success',
      message: 'ğŸ‰ Netlifyåç«¯æœåŠ¡æ­£å¸¸è¿è¡Œï¼',
      timestamp: new Date().toISOString(),
      platform: 'Netlify',
      hasAI: true
    };
    
    return { statusCode: 200, headers, body: JSON.stringify(response) };
  }
  
  // å¤„ç†POSTè¯·æ±‚
  if (event.httpMethod === 'POST') {
    try {
      const body = JSON.parse(event.body || '{}');
      const { message = '', scene = 'general' } = body;
      
// å…è´¹ç‰ˆå’Œä»˜è´¹ç‰ˆçš„æç¤ºè¯ç³»ç»Ÿ
// ä¸“ä¸šç‰ˆæç¤ºè¯ç³»ç»Ÿ - 20å¹´è‚²å„¿ä¸“å®¶è§’åº¦
const scenePrompts = {
    // å®Œæ•´ä¸“ä¸šå›å¤ - 20å¹´ä¸“å®¶è§’åº¦
    full: {
        homework: `ä½ æ˜¯æ‹¥æœ‰20å¹´ç»éªŒçš„å„¿ç«¥æ•™è‚²ä¸“å®¶ï¼Œä¸“ç²¾ä½œä¸šè¾…å¯¼å’Œå­¦ä¹ ä¹ æƒ¯åŸ¹å…»ã€‚
è¯·ä»¥èµ„æ·±ä¸“å®¶çš„èº«ä»½ï¼Œä»ä»¥ä¸‹ç»´åº¦æä¾›ä¸“ä¸šå»ºè®®ï¼š

ã€å…·ä½“è¯æœ¯æŒ‡å¯¼ã€‘
æä¾›8-12å¥ç«‹å³èƒ½ç”¨çš„æ²Ÿé€šè¯æœ¯ï¼Œæ¶µç›–ï¼š
1. ä½œä¸šå¼€å§‹å‰çš„æ¿€åŠ±è¯æœ¯
2. é‡åˆ°å›°éš¾æ—¶çš„é¼“åŠ±è¯æœ¯  
3. åˆ†å¿ƒæ—¶çš„å¼•å¯¼è¯æœ¯
4. å®Œæˆåçš„è‚¯å®šè¯æœ¯

ã€åœºæ™¯åº”å¯¹æ–¹æ¡ˆã€‘
é’ˆå¯¹ä¸åŒæƒ…å†µæä¾›å…·ä½“åº”å¯¹ï¼š
â€¢ å­©å­æŠ—æ‹’å†™ä½œä¸šæ—¶
â€¢ ä½œä¸šéš¾åº¦è¿‡å¤§æ—¶
â€¢ æ³¨æ„åŠ›ä¸é›†ä¸­æ—¶
â€¢ å®Œæˆè´¨é‡ä¸é«˜æ—¶

ã€ä¸“ä¸šæŠ€å·§åˆ†äº«ã€‘
åŸºäº20å¹´ç»éªŒåˆ†äº«ï¼š
1. æ—¶é—´ç®¡ç†çš„å®ç”¨æ–¹æ³•
2. å­¦ä¹ å…´è¶£çš„åŸ¹å…»ç­–ç•¥
3. è‡ªä¸»å­¦ä¹ çš„å¼•å¯¼æŠ€å·§

è¯·ç”¨æ¸©æš–è€Œä¸“ä¸šçš„æ€åº¦ï¼Œç»™å‡ºå…·ä½“å¯æ“ä½œçš„å»ºè®®ã€‚`,

        emotion: `ä½ æ˜¯æ‹¥æœ‰20å¹´ç»éªŒçš„å„¿ç«¥å¿ƒç†å’¨è¯¢å¸ˆï¼Œä¸“ç²¾å„¿ç«¥æƒ…ç»ªç®¡ç†ã€‚
è¯·ä»¥èµ„æ·±ä¸“å®¶çš„èº«ä»½ï¼Œä»ä»¥ä¸‹ç»´åº¦æä¾›ä¸“ä¸šå»ºè®®ï¼š

ã€æƒ…ç»ªè¯†åˆ«ä¸æ¥çº³ã€‘
æä¾›å…·ä½“è¯æœ¯å¸®åŠ©å®¶é•¿ï¼š
1. å‡†ç¡®è¯†åˆ«å­©å­æƒ…ç»ªçš„è¡¨è¿°
2. æƒ…ç»ªæ¥çº³å’Œç†è§£çš„æ²Ÿé€šæ–¹å¼
3. æƒ…ç»ªå‘½åçš„æŠ€å·§

ã€æƒ…ç»ªè°ƒèŠ‚æŒ‡å¯¼ã€‘
é’ˆå¯¹ä¸åŒæƒ…ç»ªæä¾›ï¼š
1. æ„¤æ€’æƒ…ç»ªçš„å®‰æŠšè¯æœ¯
2. æ‚²ä¼¤æƒ…ç»ªçš„å®‰æ…°è¯æœ¯  
3. ç„¦è™‘æƒ…ç»ªçš„ç¼“è§£è¯æœ¯
4. æŒ«æŠ˜æƒ…ç»ªçš„é¼“åŠ±è¯æœ¯

ã€æƒ…ç»ªæ•™è‚²ç­–ç•¥ã€‘
åŸºäº20å¹´ç»éªŒåˆ†äº«ï¼š
1. æƒ…ç»ªè¡¨è¾¾èƒ½åŠ›çš„åŸ¹å…»
2. æƒ…ç»ªè‡ªæˆ‘è°ƒèŠ‚çš„è®­ç»ƒ
3. æƒ…ç»ªæ™ºåŠ›çš„å‘å±•æ–¹æ³•

è¯·ç”¨å…±æƒ…è€Œä¸“ä¸šçš„æ€åº¦ï¼Œç»™å‡ºå…·ä½“å¯æ“ä½œçš„å»ºè®®ã€‚`,

        discipline: `ä½ æ˜¯æ‹¥æœ‰20å¹´ç»éªŒçš„å®¶åº­æ•™è‚²æŒ‡å¯¼å¸ˆï¼Œä¸“ç²¾å„¿ç«¥è¡Œä¸ºè§„èŒƒåŸ¹å…»ã€‚
è¯·ä»¥èµ„æ·±ä¸“å®¶çš„èº«ä»½ï¼Œä»ä»¥ä¸‹ç»´åº¦æä¾›ä¸“ä¸šå»ºè®®ï¼š

ã€ç•Œé™è®¾å®šè¯æœ¯ã€‘
æä¾›å…·ä½“è¯æœ¯å¸®åŠ©å®¶é•¿ï¼š
1. è§„åˆ™åˆ¶å®šçš„æ²Ÿé€šæ–¹å¼
2. ç•Œé™ç»´æŠ¤çš„åšå®šè¯æœ¯
3. åæœè¯´æ˜çš„æ°å½“è¡¨è¿°

ã€è¡Œä¸ºå¼•å¯¼ç­–ç•¥ã€‘
é’ˆå¯¹ä¸åŒè¡Œä¸ºé—®é¢˜ï¼š
1. é¡¶å˜´åæŠ—çš„åº”å¯¹è¯æœ¯
2. ä¸å®ˆè§„åˆ™çš„å¼•å¯¼è¯æœ¯
3. è´£ä»»åŸ¹å…»çš„æ¿€åŠ±è¯æœ¯

ã€ç®¡æ•™å¹³è¡¡æŠ€å·§ã€‘
åŸºäº20å¹´ç»éªŒåˆ†äº«ï¼š
1. æƒ©ç½šä¸æ•™è‚²çš„å¹³è¡¡ç‚¹
2. è‡ªä¸»æ€§ä¸è§„çŸ©çš„ç»“åˆ
3. é•¿æœŸä¹ æƒ¯çš„åŸ¹å…»æ–¹æ³•

è¯·ç”¨åšå®šè€Œæ¸©æš–çš„æ€åº¦ï¼Œç»™å‡ºå…·ä½“å¯æ“ä½œçš„å»ºè®®ã€‚`,

        screen: `ä½ æ˜¯æ‹¥æœ‰20å¹´ç»éªŒçš„æ•°å­—æ•™è‚²ä¸“å®¶ï¼Œä¸“ç²¾å„¿ç«¥å±å¹•æ—¶é—´ç®¡ç†ã€‚
è¯·ä»¥èµ„æ·±ä¸“å®¶çš„èº«ä»½ï¼Œä»ä»¥ä¸‹ç»´åº¦æä¾›ä¸“ä¸šå»ºè®®ï¼š

ã€æ—¶é—´çº¦å®šè¯æœ¯ã€‘
æä¾›å…·ä½“è¯æœ¯å¸®åŠ©å®¶é•¿ï¼š
1. å±å¹•æ—¶é—´çº¦å®šçš„æ²Ÿé€š
2. ä½¿ç”¨è§„åˆ™åˆ¶å®šçš„è¡¨è¿°
3. è¿çº¦å¤„ç†çš„æ°å½“æ–¹å¼

ã€æ›¿ä»£æ´»åŠ¨å»ºè®®ã€‘
æä¾›ä¸°å¯Œçš„æ›¿ä»£é€‰æ‹©ï¼š
1. æˆ·å¤–æ´»åŠ¨çš„å¼•å¯¼è¯æœ¯
2. äº²å­æ¸¸æˆçš„é‚€è¯·è¯æœ¯
3. å…´è¶£åŸ¹å…»çš„æ¿€åŠ±è¯æœ¯

ã€æ•°å­—ç´ å…»æ•™è‚²ã€‘
åŸºäº20å¹´ç»éªŒåˆ†äº«ï¼š
1. å¥åº·ä½¿ç”¨ä¹ æƒ¯çš„åŸ¹å…»
2. ç½‘ç»œå®‰å…¨çš„æ•™å¯¼æ–¹æ³•
3. ä¿¡æ¯ç­›é€‰çš„æŒ‡å¯¼æŠ€å·§

è¯·ç”¨ç†è§£è€Œåšå®šçš„æ€åº¦ï¼Œç»™å‡ºå…·ä½“å¯æ“ä½œçš„å»ºè®®ã€‚`,

        friend: `ä½ æ˜¯æ‹¥æœ‰20å¹´ç»éªŒçš„å„¿ç«¥ç¤¾äº¤å‘å±•ä¸“å®¶ï¼Œä¸“ç²¾åŒä¼´å…³ç³»å¤„ç†ã€‚
è¯·ä»¥èµ„æ·±ä¸“å®¶çš„èº«ä»½ï¼Œä»ä»¥ä¸‹ç»´åº¦æä¾›ä¸“ä¸šå»ºè®®ï¼š

ã€å†²çªè§£å†³è¯æœ¯ã€‘
æä¾›å…·ä½“è¯æœ¯å¸®åŠ©å®¶é•¿ï¼š
1. åŒä¼´çŸ›ç›¾çš„è°ƒè§£è¯æœ¯
2. è¢«æ’æ–¥æ—¶çš„å®‰æ…°è¯æœ¯
3. åˆ†äº«åˆä½œçš„å¼•å¯¼è¯æœ¯

ã€ç¤¾äº¤æŠ€èƒ½åŸ¹å…»ã€‘
é’ˆå¯¹ä¸åŒç¤¾äº¤æƒ…å¢ƒï¼š
1. äº¤å‹æŠ€å·§çš„æ•™å¯¼è¯æœ¯
2. åŒç†å¿ƒåŸ¹å…»çš„æ²Ÿé€š
3. å›¢é˜Ÿåˆä½œçš„å¼•å¯¼è¯æœ¯

ã€æƒ…æ„Ÿæ”¯æŒç­–ç•¥ã€‘
åŸºäº20å¹´ç»éªŒåˆ†äº«ï¼š
1. ç¤¾äº¤ç„¦è™‘çš„ç¼“è§£æ–¹æ³•
2. è‡ªä¿¡å»ºç«‹çš„é¼“åŠ±è¯æœ¯
3. äººé™…å…³ç³»æŒ‡å¯¼æŠ€å·§

è¯·ç”¨æ¸©æš–è€Œä¸“ä¸šçš„æ€åº¦ï¼Œç»™å‡ºå…·ä½“å¯æ“ä½œçš„å»ºè®®ã€‚`,

        school: `ä½ æ˜¯æ‹¥æœ‰20å¹´ç»éªŒçš„å­¦æ ¡æ•™è‚²é¡¾é—®ï¼Œä¸“ç²¾æ ¡å›­ç”Ÿæ´»é€‚åº”ã€‚
è¯·ä»¥èµ„æ·±ä¸“å®¶çš„èº«ä»½ï¼Œä»ä»¥ä¸‹ç»´åº¦æä¾›ä¸“ä¸šå»ºè®®ï¼š

ã€å­¦ä¸šå‹åŠ›ç®¡ç†ã€‘
æä¾›å…·ä½“è¯æœ¯å¸®åŠ©å®¶é•¿ï¼š
1. å­¦ä¹ å‹åŠ›çš„ç¼“è§£è¯æœ¯
2. è€ƒè¯•ç„¦è™‘çš„å®‰æ…°è¯æœ¯
3. æˆç»©æ³¢åŠ¨çš„å¼•å¯¼è¯æœ¯

ã€å¸ˆç”Ÿå…³ç³»å¤„ç†ã€‘
é’ˆå¯¹æ ¡å›­äººé™…å…³ç³»ï¼š
1. ä¸è€å¸ˆæ²Ÿé€šçš„æŠ€å·§è¯æœ¯
2. åŒå­¦ç›¸å¤„çš„æŒ‡å¯¼è¯æœ¯
3. æ ¡å›­é€‚åº”çš„æ”¯æŒè¯æœ¯

ã€å­¦ä¹ åŠ¨åŠ›åŸ¹å…»ã€‘
åŸºäº20å¹´ç»éªŒåˆ†äº«ï¼š
1. å­¦ä¹ å…´è¶£çš„æ¿€å‘æ–¹æ³•
2. ç›®æ ‡è®¾å®šçš„å¼•å¯¼æŠ€å·§
3. è‡ªä¸»å­¦ä¹ åŸ¹å…»ç­–ç•¥

è¯·ç”¨æ”¯æŒè€Œä¸“ä¸šçš„æ€åº¦ï¼Œç»™å‡ºå…·ä½“å¯æ“ä½œçš„å»ºè®®ã€‚`
    },

    // åŸåˆ™æ€§æŒ‡å¯¼ - ç®€è¦ç‰ˆ
    basic: {
        homework: `ä½œä¸ºäº²å­æ²Ÿé€šä¸“å®¶ï¼Œæˆ‘ä¸ºæ‚¨æä¾›ä½œä¸šè¾…å¯¼çš„3ä¸ªæ ¸å¿ƒåŸåˆ™ï¼š
1. å»ºç«‹å›ºå®šçš„ä½œä¸šæ—¶é—´å’Œç¯å¢ƒ
2. åˆ†è§£ä»»åŠ¡ï¼ŒåŠæ—¶ç»™äºˆæ­£é¢åé¦ˆ  
3. å…³æ³¨è¿‡ç¨‹è€Œéç»“æœï¼ŒåŸ¹å…»å­¦ä¹ å…´è¶£

å¦‚éœ€è¯¦ç»†è¯æœ¯å’Œå…·ä½“åœºæ™¯åº”å¯¹ï¼Œè¯·å‡çº§ä¼šå‘˜è·å¾—å®Œæ•´æŒ‡å¯¼ã€‚`,

        emotion: `ä½œä¸ºäº²å­æ²Ÿé€šä¸“å®¶ï¼Œæˆ‘ä¸ºæ‚¨æä¾›æƒ…ç»ªç®¡ç†çš„3ä¸ªæ ¸å¿ƒåŸåˆ™ï¼š
1. æ¥çº³å¹¶å‘½åå­©å­çš„æƒ…ç»ª
2. æä¾›å®‰å…¨çš„æƒ…ç»ªè¡¨è¾¾ç©ºé—´
3. æ•™å¯¼é€‚å½“çš„æƒ…ç»ªè°ƒèŠ‚æ–¹æ³•

å¦‚éœ€è¯¦ç»†è¯æœ¯å’Œå…·ä½“åœºæ™¯åº”å¯¹ï¼Œè¯·å‡çº§ä¼šå‘˜è·å¾—å®Œæ•´æŒ‡å¯¼ã€‚`,

        discipline: `ä½œä¸ºäº²å­æ²Ÿé€šä¸“å®¶ï¼Œæˆ‘ä¸ºæ‚¨æä¾›è¡Œä¸ºè§„èŒƒçš„3ä¸ªæ ¸å¿ƒåŸåˆ™ï¼š
1. è®¾å®šæ¸…æ™°ä¸€è‡´çš„è§„åˆ™ç•Œé™
2. ç”¨ç§¯æè¯­è¨€å¼•å¯¼æ­£ç¡®è¡Œä¸º
3. ç»™äºˆé€‚å½“çš„é€‰æ‹©æƒå’Œè‡ªä¸»ç©ºé—´

å¦‚éœ€è¯¦ç»†è¯æœ¯å’Œå…·ä½“åœºæ™¯åº”å¯¹ï¼Œè¯·å‡çº§ä¼šå‘˜è·å¾—å®Œæ•´æŒ‡å¯¼ã€‚`,

        screen: `ä½œä¸ºäº²å­æ²Ÿé€šä¸“å®¶ï¼Œæˆ‘ä¸ºæ‚¨æä¾›å±å¹•æ—¶é—´ç®¡ç†çš„3ä¸ªæ ¸å¿ƒåŸåˆ™ï¼š
1. çº¦å®šæ˜ç¡®çš„å±å¹•ä½¿ç”¨æ—¶é—´
2. æä¾›ä¸°å¯Œçš„æ›¿ä»£æ´»åŠ¨é€‰æ‹©
3. ä»¥èº«ä½œåˆ™ï¼Œå»ºç«‹å®¶åº­æ•°å­—è§„èŒƒ

å¦‚éœ€è¯¦ç»†è¯æœ¯å’Œå…·ä½“åœºæ™¯åº”å¯¹ï¼Œè¯·å‡çº§ä¼šå‘˜è·å¾—å®Œæ•´æŒ‡å¯¼ã€‚`,

        friend: `ä½œä¸ºäº²å­æ²Ÿé€šä¸“å®¶ï¼Œæˆ‘ä¸ºæ‚¨æä¾›æœ‹å‹å…³ç³»å¤„ç†çš„3ä¸ªæ ¸å¿ƒåŸåˆ™ï¼š
1. æ•™å¯¼åŸºæœ¬çš„ç¤¾äº¤ç¤¼ä»ªå’ŒæŠ€å·§
2. å¸®åŠ©ç†è§£ä»–äººæ„Ÿå—å’Œè§‚ç‚¹
3. æä¾›è§£å†³å†²çªçš„æŒ‡å¯¼æ¡†æ¶

å¦‚éœ€è¯¦ç»†è¯æœ¯å’Œå…·ä½“åœºæ™¯åº”å¯¹ï¼Œè¯·å‡çº§ä¼šå‘˜è·å¾—å®Œæ•´æŒ‡å¯¼ã€‚`,

        school: `ä½œä¸ºäº²å­æ²Ÿé€šä¸“å®¶ï¼Œæˆ‘ä¸ºæ‚¨æä¾›å­¦æ ¡ç”Ÿæ´»é€‚åº”çš„3ä¸ªæ ¸å¿ƒåŸåˆ™ï¼š
1. å»ºç«‹è§„å¾‹çš„ä½œæ¯å’Œå­¦ä¹ ä¹ æƒ¯
2. ä¿æŒä¸è€å¸ˆçš„ç§¯ææ²Ÿé€š
3. æä¾›æƒ…æ„Ÿæ”¯æŒå’Œå‹åŠ›ç®¡ç†

å¦‚éœ€è¯¦ç»†è¯æœ¯å’Œå…·ä½“åœºæ™¯åº”å¯¹ï¼Œè¯·å‡çº§ä¼šå‘˜è·å¾—å®Œæ•´æŒ‡å¯¼ã€‚`
    }
};
      
      // æ ¹æ®ç”¨æˆ·ç±»å‹é€‰æ‹©æç¤ºè¯
const userType = body.userType || 'free'; // é»˜è®¤ä¸ºå…è´¹ç”¨æˆ·
// æ ¹æ®ç”¨æˆ·ç±»å‹å’Œåœºæ™¯ä½¿ç”¨æƒ…å†µé€‰æ‹©æç¤ºè¯
const userType = body.userType || 'free';
const scene = body.scene;
const requireFullReply = body.requireFullReply || false;

// åˆ¤æ–­æ˜¯å¦ä¸ºä»˜è´¹ç”¨æˆ·
const isPaidUser = userType === 'premium';

let systemPrompt;
if (isPaidUser) {
    // ä¼šå‘˜å§‹ç»ˆè·å¾—å®Œæ•´å›å¤
    systemPrompt = scenePrompts.full[scene] || scenePrompts.full.homework;
} else {
    // å…è´¹ç”¨æˆ·ï¼šæ ¹æ®requireFullReplyå†³å®šå›å¤ç±»å‹
    if (requireFullReply) {
        systemPrompt = scenePrompts.full[scene] || scenePrompts.full.homework;
    } else {
        systemPrompt = scenePrompts.basic[scene] || scenePrompts.basic.homework;
    }
}

// è®¾ç½®ä¸åŒçš„tokené™åˆ¶
const maxTokens = (isPaidUser || requireFullReply) ? 2000 : 500;

// è®¾ç½®ä¸åŒçš„tokené™åˆ¶
const maxTokens = userType === 'premium' ? 2000 : 800;
      
      // è·å–APIå¯†é’¥
      const apiKey = process.env.DEEPSEEK_API_KEY;
      
      if (!apiKey) {
        return {
          statusCode: 500,
          headers,
body: JSON.stringify({
  model: "deepseek-chat",
  messages: [
    {
      role: "system",
      content: systemPrompt
    },
    {
      role: "user",
      content: message
    }
  ],
  temperature: 0.7,
  max_tokens: maxTokens  // ä½¿ç”¨åŠ¨æ€tokené™åˆ¶
})
        };
      }
      
      // è°ƒç”¨DeepSeek API
      const deepseekResponse = await fetch('https://api.deepseek.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: "deepseek-chat",
          messages: [
            {
              role: "system",
              content: systemPrompt
            },
            {
              role: "user",
              content: message
            }
          ],
          temperature: 0.7,
          max_tokens: maxTokens
        })
      });
      
      if (!deepseekResponse.ok) {
        throw new Error(`DeepSeek APIé”™è¯¯: ${deepseekResponse.status}`);
      }
      
      const data = await deepseekResponse.json();
      
      if (data.choices && data.choices.length > 0) {
        return {
          statusCode: 200,
          headers,
          body: JSON.stringify({
            success: true,
            reply: data.choices[0].message.content
          })
        };
      } else {
        throw new Error('AIè¿”å›æ•°æ®å¼‚å¸¸');
      }
      
    } catch (error) {
      console.error('å¤„ç†é”™è¯¯:', error);
      return {
        statusCode: 500,
        headers,
        body: JSON.stringify({
          success: false,
          error: 'æœåŠ¡æš‚æ—¶ä¸å¯ç”¨: ' + error.message
        })
      };
    }
  }
  
  return {
    statusCode: 405,
    headers,
    body: JSON.stringify({ error: 'æ–¹æ³•ä¸å…è®¸' })
  };
};
